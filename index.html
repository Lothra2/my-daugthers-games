<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Las Aventuras M√°gicas de Sophie y Alana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      /* Fondo pastel para toda la p√°gina */
      background: linear-gradient(180deg, #ffeaf2 0%, #ffd6e1 100%) no-repeat center center fixed;
      background-size: cover;
      font-family: 'Comic Sans MS', sans-serif;
      overflow: hidden;
    }
    /* Aseguramos que canvas no muestre ning√∫n fondo blanco */
    canvas {
      display: block;
      margin: 0 auto;
      border: 5px solid #ff8ad8;
      border-radius: 15px;
      background: transparent;
    }
    .rainbow-text {
      background: linear-gradient(
        90deg,
        #ff8ad8,
        #ffaaff,
        #d4aaff,
        #8fc3ff,
        #85ffab,
        #ffdf65,
        #ff8ad8
      );
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      font-weight: bold;
      display: inline-block;
    }
    #buttons {
      text-align: center;
      margin-top: 1rem;
    }
    #startButton:hover {
      animation: buttonGlow 1s infinite alternate;
    }
    @keyframes buttonGlow {
      from { box-shadow: 0 0 10px #ff6bf0; }
      to   { box-shadow: 0 0 20px #ff6bf0; }
    }
    #instructions,
    #legend {
      position: absolute;
      top: 50px;
      background: #ffebfa;
      border: 2px solid #ff8ad8;
      border-radius: 10px;
      padding: 15px;
      font-size: 16px;
      color: #ff0080;
      width: 250px;
      text-align: left;
    }
    #instructions { right: 50px; }
    #legend { left: 50px; }

    /* Ajuste para que el subt√≠tulo no pise el t√≠tulo */
    .subtitle {
      margin-top: 30px;
    }
    /* KPI board */
    #kpiBoard {
      text-align: center;
      margin-top: 10px;
    }
    #kpiBoard p {
      margin: 5px 0;
      font-weight: bold;
      color: #ff0080;
    }
  </style>
</head>
<body>
  <div class="text-center py-4">
    <h1 class="text-4xl rainbow-text">Las Aventuras M√°gicas de Sophie y Alana</h1>
    <p class="text-lg text-pink-700 subtitle">
      ¬°Ayuda al unicornio a recolectar zanahorias y a esquivar los obst√°culos!
    </p>
    <div id="buttons">
      <button id="startButton" class="mt-4 px-6 py-2 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-full">
        ¬°Iniciar Juego!
      </button>
      <button id="changeCharacterButton" class="mt-4 px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full">
        Cambiar Personaje
      </button>
      <button id="muteButton" class="mt-4 px-6 py-2 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-full">
        Silencio / Sonido
      </button>
    </div>
    <p id="score" class="mt-4 text-xl text-pink-800">Puntuaci√≥n: 0</p>
    <p id="levelDisplay" class="mt-2 text-xl text-pink-800">Nivel: 1</p>
    <p id="highScore" class="mt-2 text-xl text-pink-800"></p>
  </div>

  <!-- KPI Board extra info -->
  <div id="kpiBoard">
    <p id="timeElapsed">Tiempo: 0 s</p>
    <p id="carrotCombo">Combo Zanahorias: 0</p>
  </div>

  <canvas id="gameCanvas" width="800" height="400"></canvas>

  <div id="instructions">
    <h2 class="text-xl font-bold">Instrucciones</h2>
    <p>1. Presiona la flecha hacia arriba para saltar.</p>
    <p>2. Recoge zanahorias para ganar puntos.</p>
    <p>3. Evita los cactus, dragones y enemigos voladores (a menos que est√©s invencible).</p>
    <p>4. Power-ups:</p>
    <ul style="list-style: disc; margin-left: 20px;">
      <li><strong>‚≠ê Estrella</strong> ‚Üí Invencibilidad (5s)</li>
      <li><strong>üêå Caracol</strong> ‚Üí Ralentiza el juego (8s)</li>
      <li><strong>üî• Llama</strong> ‚Üí Doble de puntos (5s)</li>
    </ul>
    <p>¬°Divi√©rtete!</p>
  </div>

  <div id="legend">
    <h2 class="text-xl font-bold">Leyenda / Power-Ups</h2>
    <p><strong>Zanahoria (ü•ï):</strong> +10 puntos (cada 5ta seguida = +20)</p>
    <p><strong>Estrella (‚≠ê):</strong> Invencibilidad 5s</p>
    <p><strong>Caracol (üêå):</strong> Ralentiza 8s</p>
    <p><strong>Llama (üî•):</strong> Doble puntos 5s</p>
  </div>

  <script>
    // Canvas y contexto
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Elementos del DOM
    const startButton = document.getElementById('startButton');
    const changeCharacterButton = document.getElementById('changeCharacterButton');
    const muteButton = document.getElementById('muteButton');
    const scoreDisplay = document.getElementById('score');
    const levelDisplay = document.getElementById('levelDisplay');
    const highScoreDisplay = document.getElementById('highScore');

    // KPIs
    const timeElapsedDisplay = document.getElementById('timeElapsed');
    const carrotComboDisplay = document.getElementById('carrotCombo');

    // Audios
    const jumpSound = new Audio('https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg');
    const carrotSound = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
    const crashSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
    const music = new Audio('https://actions.google.com/sounds/v1/ambiences/bell.ogg');
    const starSound = new Audio('https://actions.google.com/sounds/v1/cartoon/metal_bell_ting.ogg');
    const snailSound = new Audio('https://actions.google.com/sounds/v1/cartoon/woosh_fadeout.ogg');
    const flameSound = new Audio('https://actions.google.com/sounds/v1/cartoon/descending_whistle.ogg');
    music.loop = true;

    let isMuted = false;

    // High score localStorage
    let savedData = localStorage.getItem('unicornHighScore');
    let storedHighScore = 0;
    let storedPlayerName = 'Player';
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        storedHighScore = parsed.score;
        storedPlayerName = parsed.name;
      } catch (e) {
        storedHighScore = 0;
        storedPlayerName = 'Player';
      }
    }
    let highScore = storedHighScore;
    let playerName = storedPlayerName;
    if (highScore > 0) {
      highScoreDisplay.textContent = `M√°x. Puntaje (${playerName}): ${highScore}`;
    }

    // Skins de unicornio
    const unicornSkins = ['ü¶Ñ','ü¶ì','üêé','ü¶å','üêë'];
    let currentSkinIndex = 0;

    // Variables de juego
    let level = 1;
    let score = 0;
    let carrotComboCount = 0;
    let gameRunning = false;
    let frameCount = 0;
    let gameSpeed = 1;  // Velocidad del juego

    // Para el tiempo
    let elapsedTime = 0;

    // Unicornio
    const unicorn = {
      x: 100,
      y: 300,
      width: 50,
      height: 50,
      emoji: unicornSkins[currentSkinIndex],
      jumpHeight: 12,
      gravity: 0.2,
      velocity: 0,
      isJumping: false,
      isOnGround: true,
      invincible: false,
      invincibilityTimer: 0,
      doublePoints: false,
      doublePointsTimer: 0,
      slowEffect: false,
      slowTimer: 0
    };

    // Entidades
    let carrots = [];
    let obstacles = [];
    let powerUps = [];
    let flyingEnemies = [];

    // Estrellas
    let stars = [];
    const totalStars = 50;

    // Iniciar estrellas
    function initStars() {
      stars = [];
      for (let i = 0; i < totalStars; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * (canvas.height - 100)
        });
      }
    }

    // Fondo de atardecer
    function drawSunsetBackground() {
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#662b2b');
      gradient.addColorStop(0.5, '#803232');
      gradient.addColorStop(1, '#a34b4f');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Estrellas
      ctx.fillStyle = '#fff';
      stars.forEach(star => {
        star.x -= 0.1 * gameSpeed;
        if (star.x < 0) {
          star.x = canvas.width + Math.random() * 50;
          star.y = Math.random() * (canvas.height - 100);
        }
        ctx.fillRect(star.x, star.y, 2, 2);
      });

      // Piso
      ctx.fillStyle = '#5d8b4a';
      ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
    }

    // Subir nivel cada 500 puntos
    function updateLevel() {
      level = Math.floor(score / 500) + 1;
      levelDisplay.textContent = 'Nivel: ' + level;
    }

    // Dibujo
    function drawUnicorn() {
      ctx.font = '50px Arial';
      ctx.fillText(unicorn.emoji, unicorn.x, unicorn.y);
    }
    function drawCarrots() {
      carrots.forEach(c => {
        ctx.font = '30px Arial';
        ctx.fillText('ü•ï', c.x, c.y);
      });
    }
    function drawObstacles() {
      obstacles.forEach(o => {
        ctx.font = '40px Arial';
        ctx.fillText(o.emoji, o.x, o.y);
      });
    }
    function drawFlyingEnemies() {
      flyingEnemies.forEach(f => {
        ctx.font = '40px Arial';
        ctx.fillText(f.emoji, f.x, f.y);
      });
    }
    function drawPowerUps() {
      powerUps.forEach(p => {
        ctx.font = '35px Arial';
        ctx.fillText(p.emoji, p.x, p.y);
      });
    }

    // Actualizar unicornio
    function updateUnicorn() {
      if (unicorn.isJumping && unicorn.isOnGround) {
        if (!isMuted) jumpSound.play();
        unicorn.velocity = -unicorn.jumpHeight;
        unicorn.isOnGround = false;
        unicorn.isJumping = false;
      }

      unicorn.velocity += unicorn.gravity * gameSpeed;
      unicorn.y += unicorn.velocity;

      // Suelo
      if (unicorn.y >= canvas.height - 50) {
        unicorn.y = canvas.height - 50;
        unicorn.velocity = 0;
        unicorn.isOnGround = true;
      }
      // Techo
      if (unicorn.y < 0) {
        unicorn.y = 0;
        unicorn.velocity = 0;
      }

      // Timers
      if (unicorn.invincible) {
        unicorn.invincibilityTimer--;
        if (unicorn.invincibilityTimer <= 0) {
          unicorn.invincible = false;
        }
      }
      if (unicorn.doublePoints) {
        unicorn.doublePointsTimer--;
        if (unicorn.doublePointsTimer <= 0) {
          unicorn.doublePoints = false;
        }
      }
      if (unicorn.slowEffect) {
        unicorn.slowTimer--;
        if (unicorn.slowTimer <= 0) {
          unicorn.slowEffect = false;
          gameSpeed = 1;
        }
      }
    }

    // Zanahorias
    function updateCarrots() {
      if (frameCount % Math.floor(120 / gameSpeed) === 0) {
        carrots.push({
          x: canvas.width,
          y: Math.random() * (canvas.height - 150),
          width: 30,
          height: 30
        });
      }
      carrots.forEach(c => c.x -= 3 * gameSpeed);
      carrots = carrots.filter(c => c.x > -30);
    }

    // Obst√°culos
    const obstacleEmojis = ['üåµ','üêâ'];
    function updateObstacles() {
      // Empezamos en 300 y reducimos un poco por nivel, no muy agresivo
      const obstacleInterval = Math.max(300 - (level * 20), 180);
      if (frameCount % Math.floor(obstacleInterval / gameSpeed) === 0) {
        const randomObs = obstacleEmojis[Math.floor(Math.random() * obstacleEmojis.length)];
        obstacles.push({
          x: canvas.width,
          y: canvas.height - 50,
          width: 40,
          height: 50,
          emoji: randomObs
        });
      }
      obstacles.forEach(o => o.x -= (3 + (level - 1)) * gameSpeed);
      obstacles = obstacles.filter(o => o.x > -40);
    }

    // Power-ups (‚≠ê, üêå, üî•)
    function updatePowerUps() {
      if (frameCount % Math.floor(350 / gameSpeed) === 0 && frameCount > 0) {
        const rand = Math.random();
        let typeEmoji = '‚≠ê';
        if (rand < 0.33) {
          typeEmoji = '‚≠ê';
        } else if (rand < 0.66) {
          typeEmoji = 'üêå';
        } else {
          typeEmoji = 'üî•';
        }
        powerUps.push({
          x: canvas.width,
          y: 50 + Math.random() * (canvas.height - 150),
          width: 35,
          height: 35,
          emoji: typeEmoji
        });
      }
      powerUps.forEach(p => p.x -= 4 * gameSpeed);
      powerUps = powerUps.filter(p => p.x > -35);
    }

    // Enemigos voladores
    const flyingEnemiesEmojis = ['ü¶Ö','üê≤'];
    function updateFlyingEnemies() {
      if (level > 1) {
        const flyInterval = Math.max(400 - (level * 20), 250);
        if (frameCount % Math.floor(flyInterval / gameSpeed) === 0 && frameCount > 0) {
          const randomFly = flyingEnemiesEmojis[Math.floor(Math.random() * flyingEnemiesEmojis.length)];
          flyingEnemies.push({
            x: canvas.width,
            y: 60 + Math.random() * (canvas.height - 200),
            width: 40,
            height: 40,
            emoji: randomFly
          });
        }
      }
      flyingEnemies.forEach(f => f.x -= 3 * gameSpeed);
      flyingEnemies = flyingEnemies.filter(f => f.x > -40);
    }

    // Colisiones
    function checkCollisions() {
      // Zanahorias
      carrots.forEach((c, index) => {
        if (
          unicorn.x < c.x + 30 &&
          unicorn.x + 30 > c.x &&
          unicorn.y < c.y + 30 &&
          unicorn.y + 30 > c.y
        ) {
          carrots.splice(index, 1);
          carrotComboCount++;
          let points = 10;
          if (carrotComboCount % 5 === 0) {
            points = 20;
          }
          if (unicorn.doublePoints) {
            points *= 2;
          }
          score += points;
          if (!isMuted) carrotSound.play();

          scoreDisplay.textContent = 'Puntuaci√≥n: ' + score;
          carrotComboDisplay.textContent = 'Combo Zanahorias: ' + carrotComboCount;
          updateLevel();
        }
      });

      // Power-ups
      powerUps.forEach((p, index) => {
        if (
          unicorn.x < p.x + 35 &&
          unicorn.x + 35 > p.x &&
          unicorn.y < p.y + 35 &&
          unicorn.y + 35 > p.y
        ) {
          const picked = p.emoji;
          powerUps.splice(index, 1);
          if (picked === '‚≠ê') {
            unicorn.invincible = true;
            unicorn.invincibilityTimer = 300; // ~5s
            if (!isMuted) starSound.play();
          }
          else if (picked === 'üêå') {
            unicorn.slowEffect = true;
            unicorn.slowTimer = 480; // ~8s
            gameSpeed = 0.5;
            if (!isMuted) snailSound.play();
          }
          else if (picked === 'üî•') {
            unicorn.doublePoints = true;
            unicorn.doublePointsTimer = 300; // ~5s
            if (!isMuted) flameSound.play();
          }
        }
      });

      // Obst√°culos
      obstacles.forEach(o => {
        if (!unicorn.invincible) {
          if (
            unicorn.x < o.x + 40 &&
            unicorn.x + 40 > o.x &&
            unicorn.y < o.y + 50 &&
            unicorn.y + 50 > o.y
          ) {
            if (!isMuted) crashSound.play();
            endGame();
          }
        }
      });

      // Enemigos voladores
      flyingEnemies.forEach(f => {
        if (!unicorn.invincible) {
          if (
            unicorn.x < f.x + 40 &&
            unicorn.x + 40 > f.x &&
            unicorn.y < f.y + 40 &&
            unicorn.y + 50 > f.y
          ) {
            if (!isMuted) crashSound.play();
            endGame();
          }
        }
      });
    }

    // Fin del juego
    function endGame() {
      gameRunning = false;

      // Registro de high score
      if (score > highScore) {
        highScore = score;
        highScoreDisplay.textContent = `M√°x. Puntaje (${playerName}): ${highScore}`;
        localStorage.setItem(
          'unicornHighScore',
          JSON.stringify({ score: highScore, name: playerName })
        );
      }

      const jugarDeNuevo = confirm(
        `¬°Oh no! Perdiste. Puntuaci√≥n final: ${score}\nTiempo total: ${Math.floor(elapsedTime)} s\n\n¬øQuieres jugar de nuevo?`
      );

      if (jugarDeNuevo) {
        resetGame();
        startGame(); 
      }
    }

    // Reset
    function resetGame() {
      unicorn.x = 100;
      unicorn.y = 300;
      unicorn.velocity = 0;
      unicorn.isOnGround = true;
      unicorn.invincible = false;
      unicorn.invincibilityTimer = 0;
      unicorn.doublePoints = false;
      unicorn.doublePointsTimer = 0;
      unicorn.slowEffect = false;
      unicorn.slowTimer = 0;

      carrots = [];
      obstacles = [];
      powerUps = [];
      flyingEnemies = [];

      score = 0;
      level = 1;
      carrotComboCount = 0;
      frameCount = 0;
      elapsedTime = 0;   // Reiniciamos el tiempo
      gameSpeed = 1;     // Aseguramos que arranque normal

      scoreDisplay.textContent = 'Puntuaci√≥n: 0';
      levelDisplay.textContent = 'Nivel: 1';
      carrotComboDisplay.textContent = 'Combo Zanahorias: 0';
      timeElapsedDisplay.textContent = 'Tiempo: 0 s';
    }

    // Bucle principal
    function gameLoop() {
      if (!gameRunning) return;
      frameCount++;

      // Actualizamos tiempo (asumiendo ~60 fps)
      // ~cada frame sumamos 1/60 s
      elapsedTime += 1/60;
      timeElapsedDisplay.textContent = 'Tiempo: ' + Math.floor(elapsedTime) + ' s';

      drawSunsetBackground();
      drawUnicorn();
      drawCarrots();
      drawObstacles();
      drawFlyingEnemies();
      drawPowerUps();

      updateUnicorn();
      updateCarrots();
      updateObstacles();
      updateFlyingEnemies();
      updatePowerUps();
      checkCollisions();

      requestAnimationFrame(gameLoop);
    }

    // Funci√≥n para iniciar
    function startGame() {
      gameRunning = true;
      initStars();
      gameLoop();
      if (!isMuted) {
        music.play().catch(() => {});
      }
    }

    // Controles
    document.addEventListener('keydown', e => {
      if (e.code === 'ArrowUp') {
        e.preventDefault();
        if (unicorn.isOnGround) {
          unicorn.isJumping = true;
        }
      } else if (e.code === 'Space' || e.code === 'Enter') {
        e.preventDefault();
      }
    });

    // Botones
    startButton.addEventListener('click', () => {
      if (!playerName || playerName === 'Player') {
        playerName = prompt('Escribe tu nombre:');
        if (!playerName) playerName = 'Player';
      }
      resetGame();
      startGame();
    });

    changeCharacterButton.addEventListener('click', () => {
      currentSkinIndex = (currentSkinIndex + 1) % unicornSkins.length;
      unicorn.emoji = unicornSkins[currentSkinIndex];
    });

    muteButton.addEventListener('click', () => {
      isMuted = !isMuted;
      [
        music,
        jumpSound,
        carrotSound,
        crashSound,
        starSound,
        snailSound,
        flameSound
      ].forEach(snd => {
        snd.muted = isMuted;
      });
      if (!isMuted) {
        music.play().catch(() => {});
      }
    });
  </script>
</body>
</html>
